name: Update README version

on:
  push:
    tags:
      - 'v*'   # se déclenche pour tous les tags du type v0.1.0-...

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract new version from tag
        id: version
        run: |
          NEW_VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract previous version line from README
        id: prev
        run: |
          # On récupère la ligne complète "Version actuelle : ..."
          PREV_LINE=$(grep "^Version actuelle :" README.md || true)

          # Si on a trouvé une ligne, on l'extrait proprement
          if [ -n "$PREV_LINE" ]; then
            # Exemple : "Version actuelle : v0.1.0-alpha.9-test (blabla)"
            # On récupère juste la partie après "Version actuelle : "
            PREV_ENTRY=${PREV_LINE#Version actuelle : }
            echo "entry=$PREV_ENTRY" >> "$GITHUB_OUTPUT"
          else
            echo "entry=" >> "$GITHUB_OUTPUT"
          fi

      - name: Update README (historique + version actuelle)
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          PREV_ENTRY="${{ steps.prev.outputs.entry }}"

          echo "Nouvelle version : $NEW_VERSION"
          echo "Ancienne entrée : $PREV_ENTRY"

          # 1) Si on a une ancienne entrée, on l'ajoute en haut de l'historique
          if [ -n "$PREV_ENTRY" ]; then
            if ! grep -Fq "$PREV_ENTRY" README.md; then
              awk -v prev="$PREV_ENTRY" '
                BEGIN { done=0 }
                {
                  print $0
                  if (!done && $0 ~ /^Historique rapide des versions$/) {
                    print prev
                    done=1
                  }
                }
              ' README.md > README.tmp
              mv README.tmp README.md
            fi
          fi

          # 2) On met à jour la ligne "Version actuelle : ..."
          sed -i "s/^Version actuelle :.*/Version actuelle : $NEW_VERSION/" README.md


      - name: Commit updated README
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "docs(readme): mise à jour automatique version -> ${{ steps.version.outputs.version }}"
          git push origin HEAD:main
